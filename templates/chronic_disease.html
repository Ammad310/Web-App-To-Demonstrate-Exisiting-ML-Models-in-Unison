{% extends "base.html" %}

{% block title %}Chronic Diseases{% endblock %}

{% block content %}
<link rel="stylesheet" href="static\chronic_disease.css">
<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<section class="py-5">
<div class="container mt-4">
    <!-- Left Pane -->
    <div class="left-pane">
        <div class="d-flex justify-content-center mb-3">
            <!-- Wrap the button group in a separate div with background color -->
            <div style="background-color: #f5f5f5; padding: 10px; border-radius: 20px;">
                <div class="btn-group-horizontal" role="group" aria-label="Disease Tabs">
                    {% if names %}
                    <h3>Chronic Disease (Probability)</h3>
                        {% for name in names %}
                            {% if name %}
                                <button class="btn btn-outline-primary {% if loop.index == active_tab or loop.index == 1 %}active{% endif %}" id="btn-{{ loop.index }}" onclick="showTab({{ loop.index }})">{{ name }} ({{ prob[name] }}) </button>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                    <div class="btn-group-horizontal" style=" width:1000px" role="group" aria-label="Disease Tabs">
                        <h3>Chronic Disease (Probability)</h3>
                        <div class="alert alert-success text-center" role="alert" style="font-size: 1.5rem; font-weight: bold; ">

                            The Patient has no chronic disease!
                        </div>
                        </div>
                        
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
        <!-- Pie Chart -->
         {% if names %}
        <div class="chart-container mt-4" style="width:60%; max-width: 300px; margin: 0 auto;">        
            <canvas id="diseaseProbabilitiesChart"></canvas>
        </div>
        {% endif %}
    </div>

    <!-- Right Pane -->
    <div class="right-pane">
        <div class="tab-content mt-4">
            {% for name in names %}
            <div class="tab-pane {% if loop.index == active_tab or loop.index == 1 %}show{% endif %}" id="tab-content-{{ loop.index }}" style="display: {% if loop.index == active_tab or loop.index == 1%}block{% else %}none{% endif %};">
                <div class="row">
                    <!-- Important Features Section -->
                    <div class="col-lg-12 mb-3">
                        <div class="accordion" id="accordion-important-features-{{ loop.index }}">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading-important-features-{{ loop.index }}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-important-features-{{ loop.index }}" aria-expanded="false" aria-controls="collapse-important-features-{{ loop.index }}">
                                        <div style="font-weight: bold;">Important Features</div>
                                    </button>
                                </h2>
                                <div id="collapse-important-features-{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading-important-features-{{ loop.index }}" data-bs-parent="#accordion-important-features-{{ loop.index }}">
                                    <div class="accordion-body">
                                        {% if imp[name] %}
                                            <table class="table table-striped" id="table-important-features-{{ loop.index }}">
                                                <thead>
                                                    <tr>
                                                        <th>Feature</th>
                                                        <th>Value</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for important in imp[name] %}
                                                        <tr>
                                                            <td>{{ important["Feature"] }}</td>
                                                            <td>{{ important["Value"]|float|round(1) }}</td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        {% else %}
                                            <p>No important features data available.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    

                    <!-- Risky Features Section -->
                    <div class="col-lg-12 mb-3">
                        <div class="accordion" id="accordion-risky-features-{{ loop.index }}">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading-risky-features-{{ loop.index }}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-risky-features-{{ loop.index }}" aria-expanded="false" aria-controls="collapse-risky-features-{{ loop.index }}">
                                        <div style="font-weight: bold;">Risky Features</div>
                                    </button>
                                </h2>
                                <div id="collapse-risky-features-{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading-risky-features-{{ loop.index }}" data-bs-parent="#accordion-risky-features-{{ loop.index }}">
                                    <div class="accordion-body">
                                        {% if risk[name] %}
                                            <table class="table table-striped" id="table-risky-features-{{ loop.index }}">
                                                <thead>
                                                    <tr>
                                                        <th>Feature</th>
                                                        <th>Value</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for risky in risk[name] %}
                                                        <tr>
                                                            <td>{{ risky["Feature"] }}</td>
                                                            <td>{{ risky["Value"]|float|round(1) }}</td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        {% else %}
                                            <p>No risky features data available.</p>
                                        {% endif %}
                                    </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                                    <!-- Feature Vector Section -->
                                    <div class="col-lg-12 mb-3">
                                        <div class="accordion" id="accordion-feature-vector-{{ loop.index }}">
                                            <div class="accordion-item">
                                                <h2 class="accordion-header" id="heading-feature-vector-{{ loop.index }}">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-feature-vector-{{ loop.index }}" aria-expanded="false" aria-controls="collapse-feature-vector-{{ loop.index }}">
                                                        <div style="font-weight: bold;">Feature Vector</div>
                                                    </button>
                                                </h2>
                                                <div id="collapse-feature-vector-{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading-feature-vector-{{ loop.index }}" data-bs-parent="#accordion-feature-vector-{{ loop.index }}">
                                                    <div class="accordion-body">
                                                        {% if vector[name] %}
                                                            <table class="table table-striped" id="table-feature-vector-{{ loop.index }}">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Feature</th>
                                                                        <th>Value</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {% for key, value in vector[name].items() %}
                                                                        <tr>
                                                                            <td>{{ key }}</td>
                                                                            <td>{{ value }}</td>
                                                                        </tr>
                                                                    {% endfor %}
                                                                </tbody>
                                                            </table>
                                                        {% else %}
                                                            <p>No feature data available.</p>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                <!-- Prediction Rules Button -->
                <div class="text-center mb-3">
                    <button class="btn btn-primary mt-1" style="width: 30%;" type="button" data-bs-toggle="modal" data-bs-target="#rules-modal-{{ loop.index }}">
                        Show Prediction Rules
                    </button>
                </div>

                <!-- Modal -->
                <div class="modal fade" id="rules-modal-{{ loop.index }}" tabindex="-1" aria-labelledby="rulesModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="rulesModalLabel">Prediction Rules</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                {% for rule in rules[name] %}
                                    <div class="rule-item mb-2">
                                        <hr>
                                        <div class="rule-header">
                                            Rule {{ loop.index }}
                                        </div>
                                        <div class="rule-content">
                                            <p>{{ rule.English }}</p>
                                            <p>Outcome: {{ rule["Predicate"]["Result"]["Outcome"] }}</p>
                                            <p>Probability: {{ rule["Predicate"]["Result"]["Probability"] }}</p>
                                            <p>Support: {{ rule["Support"] }}</p>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
</section>
<script>
     document.addEventListener('DOMContentLoaded', function () {
    showTab(1); // Automatically show the first tab
 
    // Convert the names and probs variables to JSON arrays
    var names = {{ names|tojson }};
    var prob = {{ prob|tojson }};
 
    // Convert the prob dictionary to an array of probabilities
    var probs = names.map(function(name) {
        return prob[name] || 0; // Provide a default value if name is not found in prob
    });
 
    // Chart.js - Pie Chart for Disease Probabilities
    var ctx = document.getElementById('diseaseProbabilitiesChart').getContext('2d');
    var diseaseProbabilitiesChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: names,
            datasets: [{
                data: probs,
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF9F80', '#FF80BF'],
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (context.parsed !== null) {
                                label += ': ' + (context.parsed*100).toFixed(2) + '%';
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
});
    document.addEventListener('DOMContentLoaded', function () {
        showTab(1); // Automatically show the first tab when the page loads
    });

    function showTab(tabIndex) {
        document.querySelectorAll('.tab-pane').forEach((pane, index) => {
            pane.style.display = index === tabIndex - 1 ? 'block' : 'none';
            pane.classList.toggle('show', index === tabIndex - 1);
        });

        document.querySelectorAll('.btn-group-horizontal .btn').forEach((button, index) => {
            button.classList.toggle('active', index === tabIndex - 1);
        });
    }
</script>

{% endblock %}

